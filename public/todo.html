<!DOCTYPE html>
<head>
	<link rel="stylesheet" href="todo.css">
	<nav class="naviBar">
		<a id="btn1" class="left" onclick="">Button1</a>
		<a id="btn2" class="left" onclick="">Btn2</a>
		<a class="seperator"></a>
		<a id="btn3" class="right" onclick="">BTN03</a>
		<!--input class="searchBar" placeholder="Search..."-->
		<!--div id="submit" class="submitButton" onclick=""-->
		<a id="btn4" class="right" onclick="">+</a>
	</nav>
	<div id="content" class="contentContainer">
	</div>
	<script>
		function createForm(title, desc, color) {
			const formContainer = document.createElement("div");
			formContainer.className = "newItemContainer";

			const formTitle = document.createElement("input");
			formTitle.type = "text";
			formTitle.placeholder = "Enter the name of the item";
			formTitle.value = title;
			formTitle.className = "catInput";

			const formDesc = document.createElement("input");
			formDesc.type = "text";
			formDesc.placeholder = "Enter a description for the item. (Optional)";
			formDesc.value = desc;
			formDesc.className = "catInput";

			const formColor = document.createElement("input");
			formColor.type = "text";
			formColor.placeholder = "Enter the color of the item. (Optional)";
			formColor.value = color;
			formColor.className = "catInput";

			const formCloseBtn = document.createElement("input");
			formCloseBtn.type = "button";
			formCloseBtn.className = "catFormBtn";
			formCloseBtn.value = "Cancel";

			const formSubmitBtn = document.createElement("input");
			formSubmitBtn.type = "button";
			formSubmitBtn.className = "catFormBtn";
			formSubmitBtn.value = "Add";

			formContainer.append(formTitle);
			formContainer.append(formDesc);
			formContainer.append(formColor);
			formContainer.append(formCloseBtn);
			formContainer.append(formSubmitBtn);

			return {
				container: formContainer,
				title: formTitle,
				desc: formDesc,
				color: formColor,
				submitBtn: formSubmitBtn,
				closeBtn: formCloseBtn
			}
		}
		
		function appendNode(node) {

			if (node.layer == -1) {

			}
		}

		class createNodeBtn {
			#container;
			#icon;
			#expanded;
			#form;

			constructor() {
				this.init();
			}

			init() {
				this.expanded = false;

				this.container = document.createElement("div");
				this.container.className = "addCatFormContainer";
				this.container.addEventListener('click', () => {
					this.expand();
				});

				this.icon = document.createElement("a");
				this.icon.className   = "plus";
				this.icon.textContent = "+";

				this.container.append(this.icon);

				const contentContainer = document.getElementById("content");
				contentContainer.append(this.container);
			}

			expand() {
				if (this.expanded == true) { return; }
				this.expanded = true;
				this.form = createForm("", "", "");

				this.container.removeChild(this.icon);
				this.container.classList.toggle("addCatFormContainerExpanded");

				setTimeout(() => {
					this.container.append(this.form.container);
					this.form.title.focus();
					this.form.closeBtn.addEventListener('click', () => {
						this.removeSelf();
						new createNodeBtn();
					});

					this.form.submitBtn.addEventListener('click', () => {
						const formTitleValue = (this.form.title.value).trim();
						const formDescValue = (this.form.desc.value).trim();
						if (formTitleValue === "") {
							this.form.title.focus();
							return;
						}
						const contentContainer = document.getElementById("content");
						
						new node(contentContainer, formTitleValue, formDescValue, "", "", -1).container;

						this.reAppend();
					});
				}, 100);
			}

			removeSelf() {
				const contentContainer = document.getElementById("content");
				contentContainer.removeChild(this.container);
			}

			// function to remove self and append new instance of class at the bottom of the content
			reAppend() {
				this.removeSelf();
				new createNodeBtn();
			}
		}

		function titleElement(titleContent) {
			const title = document.createElement('a');
			title.className   = 'title';
			title.textContent = titleContent;

			return title;
		}

		function descElement(descContent) {
			const desc = document.createElement('a');
			desc.className   = 'desc';
			desc.textContent = descContent;

			return desc;
		}

		function tickboxElement(ticked) {
			const tickbox = document.createElement('input');
			tickbox.type = 'checkbox';
			tickbox.className = 'tickbox';
			tickbox.checked = ticked;
			tickbox.disabled = true;

			return tickbox;
		}

		function editIcon() {
			const editBtn = document.createElement('img');
			editBtn.src   = 'assets/edit.svg';
			editBtn.alt   = 'SVG Image';
			editBtn.className = 'optionBtn';

			return editBtn;
		}

		function plusIcon() {
			const plusIcon = document.createElement('img');
			plusIcon.src   = 'assets/plus.svg';
			plusIcon.alt   = 'SVG Image';
			plusIcon.className = 'optionBtn';

			return plusIcon;
		}

		function crossIcon() {
			const crossIcon = document.createElement('img');
			crossIcon.src   = 'assets/cross.svg';
			crossIcon.alt   = 'SVG Image';
			crossIcon.className = 'optionBtn';

			return crossIcon;
		}

		class popupView {
			constructor(content) {
				const background = document.createElement("div");
				background.className = "addCatFormPopupBackground";
				document.body.appendChild(background);
				document.body.style.overflow = "hidden";

				background.addEventListener("click", function() {
					document.body.removeChild(background);
					document.body.removeChild(form);
					document.body.style.overflow = "auto";
				});

			const form = document.createElement("div");
			form.className = "addCatFormPopup";
			document.body.appendChild(form);

			}
		}

		class optionsBar {
			#container
			#addBtn
			#editBtn
			constructor() {
				this.container = document.createElement('div');
				this.container.className = 'optionsBar';
				
				this.addBtn   = plusIcon();
				this.editBtn  = editIcon();
				this.crossBtn = crossIcon();
				
				this.container.append(this.editBtn);
				this.container.append(this.addBtn);
				this.container.append(this.crossBtn);
			}
		}

		class node {
			#parent
			#container
			#title;
			#desc;
			#descSeperator;
			#color;
			#tickbox;
			#layer;
			#optionsBar;
			#form;
			#formOpened
			#catSeperator
			constructor(parent, title, desc, color, ticked, layer) {
				this.parent = parent;
				this.layer  = layer;
				this.title = titleElement(title);
				this.desc = descElement(desc);
				this.descSeperator = document.createElement("hr");
				this.descSeperator.className = "titleSeperator";
				this.tickbox = tickboxElement(ticked);
				this.optionsBar = new optionsBar();

				this.init();
			}
			init() {
				this.container = document.createElement('div');
				this.container.className = this.checkLayer(this.layer); // todo - update function?
				this.container.draggable = true;

				this.container.ondragstart = (event) => {
					if (event.target === this.container) {
						console.log(event.target);
						console.log("drag started");
					}
				}
				this.container.ondragend = (event) => {
					if (event.target !== this.container) {
						return;
					}
					const element = document.elementFromPoint(event.clientX, event.clientY);

					console.log("drag end");
					//console.log(event.target);
					console.log("Element under cursor:", element);

					if (element.className == 'category'
					||  element.classList.contains('item')) {
						element.append(this.container);
					}

				}
				/*
				notes: update layer on move
				*/

				this.container.append(this.title);
				this.container.append(this.tickbox);

				if (this.desc.textContent != "") {
					this.container.append(this.descSeperator);
					this.container.append(this.desc);
				}

				this.container.append(this.optionsBar.container);

				this.parent.append(this.container);
				if(this.layer == -1) {
					this.catSeperator= document.createElement("hr");
					this.catSeperator.className = "seperator";
					this.parent.append(this.catSeperator);
				}

				this.initTickDetection();
				this.initAddBtnDetection();
				this.initEditDetection();
				// this.initHoverDetection();
				// test(this.container);
				this.initDeleteDection();
			}

			checkLayer(layer) {
				if (layer == -1) { return "category"; }
				const layerOdd = layer % 2;
				if (layerOdd == 1) { return "item itemWhite"; }
				else               { return "item itemGray";	}
			}

			initTickDetection() {
				this.container.addEventListener('click', (event) => {
					if (event.target == this.container || event.target == this.tickbox) {
						this.tickbox.checked = !this.tickbox.checked;
						if (this.tickbox.checked) {
							this.title.style.textDecoration = "line-through";
						} else {
							this.title.style.textDecoration = "none";
						}
					}
				});
			}

			initAddBtnDetection() {
				this.optionsBar.addBtn.addEventListener('click', (event) => {
					if (this.formOpened == 1) {
						this.form.title.focus();
						return;
					} else { this.formOpened = 1; }
					
					this.form = createForm("", "", "");
					this.container.append(this.form.container);
					this.form.title.focus();

					this.form.closeBtn.addEventListener('click', () => {
						this.removeForm();
					});

					this.form.submitBtn.addEventListener('click', () => {
						const formTitleValue = (this.form.title.value).trim();
						const formDescValue = (this.form.desc.value).trim();
						if (formTitleValue === "") {
							this.form.title.focus();
							return;
						}
						new node(this.container, formTitleValue, formDescValue, "", "", (this.layer + 1)).container;
						this.removeForm();
						this.optionsBar.container.classList.remove('optionsHover');
					});
				});
			}

			initEditDetection() {
				this.optionsBar.editBtn.addEventListener('click', (event) => {
					if (this.formOpened == 1) {	return;	}

					this.form = createForm(this.title.textContent, this.desc.textContent, "");
					if (this.desc.textContent != "") {
						this.desc.insertAdjacentElement('afterend', this.form.container);
					} else {
						this.title.insertAdjacentElement('afterend', this.form.container);
					}
					this.form.title.focus();

					this.form.closeBtn.addEventListener('click', () => {
						this.removeForm();
					});

					this.form.submitBtn.addEventListener('click', () => {
						const formTitleValue = (this.form.title.value).trim();
						const formDescValue = (this.form.desc.value).trim();
						if (formTitleValue === "") {
							this.form.title.focus();
							return;
						}
						this.removeForm();

						this.title.textContent = formTitleValue;

						if (formDescValue == "" && this.desc.textContent != "") {
							this.removeDesc();
							return;
						}
						if (formDescValue != "" && this.desc.textContent == "") {
							this.appendDesc();
						}
						
						this.desc.textContent = formDescValue;
						this.optionsBar.container.classList.remove('optionsHover');
					});
				});
			}

			initDeleteDection() {
				this.optionsBar.crossBtn.addEventListener('click', () => {
					if (this.layer == -1) {
						this.parent.removeChild(this.catSeperator);
					}
					this.parent.removeChild(this.container);
					// this.popupView("Enter ...");
				});
			}

			initHoverDetection() {
				document.body.addEventListener('mouseover', (event) => {
					console.log(event.target)
					if (event.target === this.container
					|| event.target === this.optionsBar.addBtn
					|| event.target === this.optionsBar.editBtn
					|| event.target === this.optionsBar.crossBtn
					|| event.target === this.title
					|| event.target === this.desc
					) {
						this.optionsBar.container.classList.add('optionsHover');
					}

					if (event.target !== this.container) {
						this.optionsBar.container.classList.remove('optionsHover');
					}
					// issues with leaving the element
					/* possible solution to create document body event listener
					rather than sep listeners for each node */
				});
			}

			removeForm() {
				this.container.removeChild(this.form.container);
				this.formOpened = 0;
			}

			appendDesc() {
				this.title.insertAdjacentElement("afterend", this.descSeperator);
				this.descSeperator.insertAdjacentElement("afterend", this.desc);
			}

			removeDesc() {
				this.desc.textContent = "";
				this.container.removeChild(this.descSeperator);
				this.container.removeChild(this.desc);
			}

			popupView(content) {
				const background = document.createElement("div");
				background.className = "addCatFormPopupBackground";

				const formContainer = document.createElement('div');
				formContainer.className = "addCatFormPopup";

				const title = document.createElement('a');
				title.className = 'title';
				title.textContent = content;

				formContainer.append(title);
				background.append(formContainer);
				document.body.append(background);
				document.body.style.overflow = "hidden";

				background.addEventListener("click", function() {
					document.body.removeChild(background);
					document.body.style.overflow = "auto";
				});
			}
		}

		const contentContainer = document.getElementById("content");
		
		// test nodes
		//new node(contentContainer, "title", "desc", "", "", -1);
		//new node(contentContainer, "title", "", "", "", -1);

		new createNodeBtn();
	</script>
</head>
